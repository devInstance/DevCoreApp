@page "/profile"

<PageTitle Value="Profile"></PageTitle>
<div class="row mb-3">
    <div class="col">
        <h2>Profile</h2>
        @if (Item != null)
        {
            if (!IsEditing)
            {
                <table class="table">
                    <tr>
                        <td>Name:</td>
                        <td>@Item.Name</td>
                    </tr>
                    <tr>
                        <td>Email:</td>
                        <td>@Item.Email</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Member since:</td>
                        <td class="text-muted">@Item.CreateDate</td>
                    </tr>
                </table>
                <button class="btn btn-outline-primary" @onclick="@(() => StartEditing())"><i class="oi bi-pencil" aria-hidden="true"></i><span>Edit</span></button>
            }
            else
            {
                <EditForm class="form-signin" OnValidSubmit="OnSubmit" Model="Item">
                    <label for="inputUsername" class="sr-only">Name:</label>
                    <InputText id="inputUsername" class="form-control" @bind-Value="Item.Name" autofocus placeholder="Username" />
                    <label for="inputEmail" class="sr-only">Email:</label>
                    <InputText id="inputEmail" class="form-control mb-3" @bind-Value="Item.Email" autofocus placeholder="Username" />
                    <button class="btn btn-primary btn-block" type="submit">Update</button>
                    <button class="btn btn-outline-primary" @onclick="@(() => CancelEditing())">Cancel</button>
                </EditForm>
            }
        }
        else
        {
            <PageProgress></PageProgress>
        }
    </div>
</div>
@if (!IsEditing)
{
<div class="row">
    <div class="col">
        <h5>Delete Account</h5>
        <p class="text-danger">Warning: This action cannot be undone. All the data will be removed permanently</p>
        <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#addDeleteModal"><i class="oi bi-trash" aria-hidden="true"></i><span>Delete</span></button>
    </div>
</div>
<div class="modal fade" id="addDeleteModal" tabindex="-1" aria-labelledby="addDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProjectModalLabel">Are you sure?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-danger">Warning: This action cannot be undone. All the data will be removed permanently</p>
                <p>Are you sure you want to delete this account ?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" @onclick="OnDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

}

@inject IScopeManager ScopeManager;
@inject AccountService Service;
@inject AuthorizationService AuthorizationServ;
@inject NavigationManager NavigationManager;

@implements IDisposable

@code {

    private UserProfileItem Item { get; set; }

    private IScopeLog log;

    private bool IsEditing { get; set; } = false;

    string error { get; set; }

    protected async override Task OnInitializedAsync()
    {
        log = ScopeManager.CreateLogger(this);
        using (var l = log.TraceScope())
        {
            Item = await Service.GetAccountAsync();
        }
    }

    public void Dispose()
    {
        using (var scope = log.TraceScope())
        {
        }
    }

    public void StartEditing()
    {
        IsEditing = true;
        StateHasChanged();
    }

    public void CancelEditing()
    {
        IsEditing = false;
        StateHasChanged();
    }

    public async Task OnSubmit()
    {
        error = null;
        try
        {
            await Service.UpdateUserProfileAsync(Item);
            IsEditing = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private async void OnDelete(object value)
    {
        await AuthorizationServ.DeleteAsync();
        NavigationManager.NavigateTo("/authentication/login");
    }
}
