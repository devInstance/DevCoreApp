@page "/admin/email-log"
@attribute [Authorize(Roles = "Owner,Admin")]

<PageTitle>Email Log</PageTitle>

<div class="row mb-3">
    <div class="col col-md-6 col-lg-4 d-flex">
        <input class="form-control" placeholder="Search emails..." @bind="SearchTerm" @bind:event="oninput" disabled="@Host.InProgress" />
        <button class="btn btn-primary ms-2" @onclick="OnSearch" disabled="@Host.InProgress">
            <i class="bi bi-search"></i>
        </button>
    </div>
    <div class="col col-md-6 col-lg-8">
        <div class="d-flex align-items-center justify-content-end gap-2">
            <select class="form-select" style="width: auto;" @bind="StatusFilter" disabled="@Host.InProgress">
                <option value="">All Statuses</option>
                <option value="0">Batched</option>
                <option value="1">Sent</option>
                <option value="2">Failed</option>
            </select>
            <input type="date" class="form-control" style="width: auto;" @bind="StartDateFilter" disabled="@Host.InProgress" />
            <input type="date" class="form-control" style="width: auto;" @bind="EndDateFilter" disabled="@Host.InProgress" />
            <button class="btn btn-outline-primary" @onclick="OnApplyFilters" disabled="@Host.InProgress">
                <i class="bi bi-funnel"></i> Filter
            </button>
            <button class="btn @(GroupByStatus ? "btn-secondary" : "btn-outline-secondary")" @onclick="ToggleGroupByStatus" disabled="@Host.InProgress">
                <i class="bi bi-collection me-1"></i>Group by Status
            </button>
            @if (SelectedIds.Count > 0)
            {
                <button class="btn btn-danger" @onclick="OnDeleteSelected" disabled="@Host.InProgress">
                    <i class="bi bi-trash me-1"></i>Delete Selected (@SelectedIds.Count)
                </button>
            }
            <button class="btn btn-warning" @onclick="OnResendAllFailed" disabled="@Host.InProgress">
                <i class="bi bi-arrow-repeat me-1"></i>Resend All Failed
            </button>
        </div>
    </div>
</div>

<HDataGrid TItem="DevInstance.DevCoreApp.Shared.Model.EmailLogItem"
           Data="EmailLogList"
           Columns="Columns"
           IsLoading="Host.InProgress"
           OnSort="OnSortAsync"
           OnPageChanged="OnPageChangedAsync"
           OnColumnsChanged="OnColumnsChanged"
           EnableSelection="true"
           SelectedIds="SelectedIds"
           SelectedIdsChanged="OnSelectionChanged"
           IdSelector="e => e.Id"
           OnRowClick="OnRowClick"
           GroupBy="@(GroupByStatus ? (e => e.Status) : null)"
           GroupsCollapsedByDefault="false">
    <EmptyContent>
        <p>No email log entries found.</p>
    </EmptyContent>
    <SearchContent>
        <div class="alert alert-light">
            Searching for <strong>@context</strong>
            <button type="button" class="btn-close ms-2" @onclick="OnClearSearch"></button>
        </div>
    </SearchContent>
    <GroupHeaderTemplate>
        <strong>@context.Key</strong>
        <span class="badge bg-secondary ms-2">@context.Count</span>
    </GroupHeaderTemplate>
</HDataGrid>

<GridSettings Columns="Columns" OnSave="OnSave" PageSize="pageCount" TItem="DevInstance.DevCoreApp.Shared.Model.EmailLogItem" />
